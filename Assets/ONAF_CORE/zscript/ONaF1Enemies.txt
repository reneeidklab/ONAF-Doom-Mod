Class Redman : Actor
{
	Private Bool HaveATarget;
	Private Bool MonsterCrouching;
	Private Int TargetDelay;
	Private Int SearchTarget;
	Private int Delay;
	Private Int InDuct;
	private double angleLerpSpeed;
	override void PostBeginPlay()
	{
		Super.PostBeginPlay();
		SearchTarget = 23;
		TargetDelay = 30;
		HaveATarget = FALSE;
		MonsterCrouching = FALSE;
		Delay = 30;
		InDuct = 2;
		angleLerpSpeed = 0.35;
	}
	Bool CheckFloorTexture(String texName)
    {
        String floorTex = TexMan.GetName(self.floorpic);
        return (floorTex == texName);
    }
	void FootStep()
	{
		If (CheckFloorTexture("FTILES1") || CheckFloorTexture("CONC5") || CheckFloorTexture("CONC4") || CheckFloorTexture("CONC2")) { A_PlaySound("MonsterTileStep",0,5.0); }
		Else If (CheckFloorTexture("CARPETS1") || CheckFloorTexture("CARPETS2") || CheckFloorTexture("CARPETS3") || CheckFloorTexture("CARPETS6")) { A_PlaySound("MonsterCarpetStep",0,5.0); }
		Else If (CheckFloorTexture("METL1") || CheckFloorTexture("METL2")) { A_PlaySound("MonsterVentStep",0,5.0); }
		Else If (CheckFloorTexture("GLAS1")) { A_PlaySound("MonsterGlassStep",0,5.0); }
		Else If (CheckFloorTexture("TDIRT")) { A_PlaySound("MonsterGrassStep",0,5.0); }
		Else If (CheckFloorTexture("CONC1")) { A_PlaySound("MonsterStoneStep",0,5.0); }
		Else If (CheckFloorTexture("OWOOD1")) { A_PlaySound("MonsterWoodStep",0,5.0); }
	}
	override void Tick()
    {
        Super.Tick();
	//New target
		if (target)
		{
			If (CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING)) { HaveATarget = TRUE; }
		}
	//Lose Target
		if (target)
		{
			if (!CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING) && HaveATarget == TRUE)
			{
				if (TargetDelay-- <= 0)
				{
					TargetDelay = 30;
					SearchTarget -= 1;
					if (SearchTarget <= 0) 
					{ 
						SearchTarget = 23;
						HaveATarget = FALSE;
					}
				}
			}
		}
	//If no Duct
		if (!CheckFloorTexture("METL2") && MonsterCrouching == TRUE)
		{
			//Console.printf("%s == InDuct %d", self.GetClassName(), InDuct);
			if (Delay-- <= 0)
			{
				Delay = 30;
				InDuct -= 1;
				if (InDuct <= 0) 
				{ 
					InDuct = 2;
					SetStateLabel("ToStand");
					A_Stop();
					A_SetSize(-1,64);
					MonsterCrouching = FALSE;
				}
			}
		}
    }
	void My_ImprovedChase(statelabel MeleeState)
	{
		If (HaveATarget == FALSE || CheckFloorTexture("OWOOD1"))
		{
			A_Wander(CHF_NORANDOMTURN);
			If (CheckIfTargetInLOS(360.0,0,46)) { SetStateLabel("Jumpscare"); }
			Return;
		}
		Else If (HaveATarget == TRUE)
		{
			Actor target = self.target;
			if (!target)
				return;
			If (Target && Target.Health > 0)
			{
			double distanceToTarget = Distance3D(target);
				if (distanceToTarget < MeleeRange)
				{
					SetStateLabel(MeleeState);
					return;
				}
			}
			If (!CheckIfTargetInLOS(180.0,0,0))
			{ 
				A_Chase(MeleeState,null); 
				Return;
			}
			
			double dx = target.pos.x - self.pos.x;
			double dy = target.pos.y - self.pos.y;
			double distancia = sqrt(dx*dx + dy*dy);
			if (distancia > 0) { dx /= distancia; dy /= distancia; }
			double desiredAngle = VectorAngle(dx, dy);
			double currentAngle = self.angle;
			double angleDiff = DeltaAngle(currentAngle, desiredAngle);
			double newAngle = currentAngle + angleDiff * angleLerpSpeed;
			self.angle = newAngle;
			double moveSpeed = self.speed;
			self.vel.x = Cos(newAngle) * moveSpeed;
			self.vel.y = Sin(newAngle) * moveSpeed;
			A_SetSpeed(moveSpeed);
		}
	}
	Void A_RedmanIdle()
	{
		If (MonsterCrouching == FALSE)
		{
			A_LookEx(LOF_NOSOUNDCHECK,0,0,0,90,"WalkChase");
			If (Random(0, 256) > 75)
			{
				int RandomDecide = random(1,4);
				switch (RandomDecide)
				{
					Case 1:
					SetStateLabel("Idle");
					Break;
					Case 2:
					SetStateLabel("WalkChase");
					Break;
					Case 3:
					SetStateLabel("RunChase");
					Break;
					Case 4:
					SetStateLabel("PowerDrain");
					Break;
				}
			}
		}
		Else If (MonsterCrouching == TRUE)
		{
			A_LookEx(LOF_NOSOUNDCHECK,0,0,0,90,"CrouchWalkChase");
			If (Random(0, 256) > 75) { SetStateLabel("CrouchWalkChase"); }
		}
	}
	void A_RedmanWalkChase()
	{
		My_ImprovedChase("Jumpscare");
		If (MonsterCrouching == FALSE)
		{
			If (CheckProximity("VentNear",24.0,1,AAPTR_DEFAULT)) { SetStateLabel("ToCrouch"); }
			Speed = 3.6;
			If (Random(0,825) > 824 && CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING)) { SetStateLabel("RunChase"); }
		}
		Else if (MonsterCrouching == TRUE)
		{
			Speed = 4.2;
		}
	}
	Void A_RedmanRunChase()
	{
	//No have checks if Enemy on Vent because he don't run in vents.	
		If (CheckProximity("VentNear",24.0,1,AAPTR_DEFAULT)) { SetStateLabel("ToCrouch"); }
		Speed = 11.6;
		My_ImprovedChase("Jumpscare");
		If (Random(0,276) > 275 && !CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING))
		{
			int RandomDecide = random(1,2);
			switch (RandomDecide)
			{
				Case 1:
				SetStateLabel("Idle");
				Break;
				Case 2:
				SetStateLabel("WalkChase");
				Break;
			}
		}
	}
	Void A_RedmanPowerDrain()
	{
		A_FaceTarget(7);
		if (CheckProximity("FlashlightLight",16.0,1,0,AAPTR_DEFAULT)) { A_TakeInventory("IsDrainPower",1); SetStateLabel("Idle"); }
	}
	Default
	{
		Height 64;
		Radius 13;
		SCALE 9.2;
		PainChance 0;
		MeleeRange 46;
		MaxStepHeight 500;
		MaxDropOffHeight 500;
		Monster;
		+NOPAIN
		+NOBLOOD
		+NOBLOODDECALS
		+SLIDESONWALLS
		+INVULNERABLE
		+NODAMAGE
		+DECOUPLEDANIMATIONS
	}
	States
	{
	Spawn:
		M000 A 1 SetAnimation('TPose', FrameRate: 35, flags:SAF_NOOVERRIDE);
		M000 A 1 A_LookEx(0,0,0,0,360,"Idle");
		Loop;
	Deactive:
		M000 A 1 SetAnimation('Deactived', FrameRate: 35, flags:SAF_NOOVERRIDE);
		Loop;
	Active:
		M000 A 1 SetAnimation('Active', FrameRate: 35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
		M000 A 1
		{
			int RandomDecide = random(1,3);
			switch (RandomDecide)
			{
				Case 1:
				SetStateLabel("WalkChase");
				Break;
				Case 2:
				SetStateLabel("RunChase");
				Break;
				Case 3:
				SetStateLabel("PowerDrain");
				Break;
			}
		}
		Wait;
	Idle:
		M000 A 1 SetAnimation('Idle', framerate:17.5, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1 A_RedmanIdle();
		Loop;
	WalkChase:
		M000 A 1 SetAnimation('Walk', framerate:35, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
	WalkChaseLoop:
		M000 A 1 
		{
			FootStep();
			FootStep();
			A_RedmanWalkChase();
		}
		M000 AAAAAAAAAAAAAAAAAAA 1 A_RedmanWalkChase();
		M000 A 1 
		{
			FootStep();
			FootStep();
			A_RedmanWalkChase();
		}
		M000 AAAAAAAAAAAAAAAAAAAAA 1 A_RedmanWalkChase();
		Loop;
	RunChase:
		M000 A 1 SetAnimation('Run', framerate:35, interpolatetics: 4, flags:SAF_LOOP|SAF_NOOVERRIDE);
	RunChaseLoop:
		M000 AAA 1 A_RedmanRunChase();
		M000 A 1
		{
			FootStep();
			FootStep();
			A_RedmanRunChase();
		}
		M000 AAAAAAAAAAA 1 A_RedmanRunChase();
		M000 A 1
		{
			FootStep();
			FootStep();
			A_RedmanRunChase();
		}
		M000 AAAAAAAAAAA 1 A_RedmanRunChase();
		Loop;
	PowerDrain:
		M000 A 1 SetAnimation('PowerDrain', framerate:35, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 A 0 
		{ 
			If (CountInv('HourPlusOne') < 4)
			{ 
				SetStateLabel("Idle"); 
			} 
		}
		M000 A 1 
		{
			A_RedmanPowerDrain();
			A_GiveInventory("IsDrainPower",1);
		}
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1 A_RedmanPowerDrain();
		Loop;
	ToStand:
		M000 A 1 SetAnimation('Idle', framerate:35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1
		{
			A_SetSize(-1,64);
			MonsterCrouching = FALSE;
		}
		M000 A 6;
		Goto Idle;
	ToCrouch:
		M000 A 1 SetAnimation('CrouchIdle', framerate:35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1
		{
			A_SetSize(-1,16);
			MonsterCrouching = TRUE;
		}
		M000 A 6;
	CrouchIdle:
		M000 A 1 SetAnimation('CrouchIdle', framerate:17.5, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1 A_RedmanIdle();
		Loop;
	CrouchWalkChase:
		M000 A 1 SetAnimation('CrouchWalk', framerate:52.5, interpolatetics: 5, flags:SAF_LOOP|SAF_NOOVERRIDE);
	CrouchWalkChaseLoop:
		M000 A 1
		{
			FootStep();
			FootStep();
			A_RedmanWalkChase();
		}
		M000 AAAAAAAAAAAAAAAAAA 1 A_RedmanWalkChase();
		M000 A 1
		{
			FootStep();
			FootStep();
			A_RedmanWalkChase();
		}
		M000 AAAAAAAAAAAAAAAAAAAAA 1 A_RedmanWalkChase();
		Loop;
	Jumpscare:
		M000 A 1 
		{
			If (MonsterCrouching == TRUE) { SetAnimation('CrouchJumpscare', framerate:35, interpolatetics: 5, flags:SAF_NOOVERRIDE); }
			Else if (MonsterCrouching == FALSE) { SetAnimation('Jumpscare', framerate:35, interpolatetics: 5, flags:SAF_NOOVERRIDE); }
		}
		M000 A 1
		{
			A_FaceTarget();
			A_SetAngle(Angle + 180,SPF_INTERPOLATE,AAPTR_TARGET);
			A_QuakeEx( 1, 1, 1, 15, 0, 64, "", 0, 1, 1, 1, 0, 0, 3, 1);
			A_PlaySound("RedmanScream",0,1.0);
			ACS_NamedExecuteAlways("EnemyAttack",0,0,0,0);
		}
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
		M000 A 1
		{
			If (MonsterCrouching == TRUE) { SetStateLabel("CrouchWalk"); }
			Else if (MonsterCrouching == FALSE) { SetStateLabel("RunChase"); }
		}
		Wait;
	}
}

class GoldenFlumpty1 : Actor
{
	private int aggro;
	private int PlayerCounter;
	private int needstarget;
	private int playercount;
	private int night;
	private double angleLerpSpeed;
	override void PostBeginPlay()
	{
	angleLerpSpeed = 0.35;
	aggro = 0;
	PlayerCounter = 0;
	night = 7;
	needstarget = 0;
	playercount = 0;
	if (level.mapname == "e1m1")
	{
		night = 1;
	}
	else if (level.mapname == "e1m2")
	{
		night = 2;
	}
	for (int i = 0; i < players.size(); i++)
		if (playeringame[i])
			playercount++;
	Super.PostBeginPlay(); // call the super function for virtual functions so we don't break shit if GZdoom update.
	}
	void My_ImprovedChase(statelabel MeleeState)
	{
		Actor target = self.target;
		if (!target)
			return;
		If (Target && Target.Health > 0)
		{
		double distanceToTarget = Distance3D(target);
			if (distanceToTarget < MeleeRange)
			{
				SetStateLabel(MeleeState);
				return;
			}
		}
		If (!CheckIfTargetInLOS(180.0,0,0))
		{ 
			A_Chase(MeleeState,null); 
			Return;
		}
		double dx = target.pos.x - self.pos.x;
		double dy = target.pos.y - self.pos.y;
		double distancia = sqrt(dx*dx + dy*dy);
		if (distancia > 0) { dx /= distancia; dy /= distancia; }
		double desiredAngle = VectorAngle(dx, dy);
		double currentAngle = self.angle;
		double angleDiff = DeltaAngle(currentAngle, desiredAngle);
		double newAngle = currentAngle + angleDiff * angleLerpSpeed;
		self.angle = newAngle;
		double moveSpeed = self.speed;
		self.vel.x = Cos(newAngle) * moveSpeed;
		self.vel.y = Sin(newAngle) * moveSpeed;
		A_SetSpeed(moveSpeed);
	}
	void A_GFlumptyThink()
    {
		A_RadiusThrust(100,64,RTF_NOTMISSILE|RTF_NOIMPACTDAMAGE,64);
		A_FaceTarget();
		if (CheckIfInTargetLOS(75.0, 0, 0, 0))
			{
			playercounter += 1+playercount+(night*2);
				if (playercounter > 100)
				{
					aggro = aggro+(10+(playercount*4));
					playercounter = 0;
				}
					else if (!CheckIfInTargetLOS(75.0, 0, 0, 0))
					{
					Aggro = aggro - (17-playercount);
					}
				If (aggro > 750)
				{
				A_GiveToTarget("blackout",1);
				aggro = 0;
				SetStateLabel("Wander");
				}
			}
    }
	void A_GoldenFlumptyChase()
	{
		A_RadiusThrust(100,64,RTF_NOTMISSILE|RTF_NOIMPACTDAMAGE,64);
		My_ImprovedChase("null");
		A_LookEx(LOF_NOSOUNDCHECK,0,0,0,180,"LookAt");
	}
	Default
	{
		Health 2;
		Radius 23;
		Height 64;
		Mass 1000;
		Speed 5.0;
		Scale 0.5;
		PainChance 0;
		MeleeRange 88;
		CameraHeight 80;
		MaxStepHeight 500;
		MaxDropOffHeight 500;
		Species "Monster";
		RenderStyle "Normal";
		Alpha 1.0;
		Monster;
		-SOLID;
		+NOPAIN;
		+LOOKALLAROUND;
		+SLIDESONWALLS;
		+INVULNERABLE;
		+NODAMAGE;
		+DROPOFF;
		+INTERPOLATEANGLES;
		SeeSound "";
		PainSound "";
		DeathSound "";
		ActiveSound "";
		Obituary "%o met their fate to Golden Flumpty";
	}
	
	States
	{
		Stage:
			TNT1 A 1;
			Loop;
		Spawn:
			CYBI A 1;
			CYBI A 1 A_StopSound(2);
		Chase:
			#### # 4
			{
				A_SetSpeed(14.0, AAPTR_DEFAULT);
				A_StopSound(2);
				aggro = 0;
			}
			CYBI BCDEFGHIJKLMNOPQRST 1 A_GoldenFlumptyChase();
			Loop;
		LookAt:
			#### # 6
			{
				A_GFlumptyThink();
				A_SetSpeed(1.0,AAPTR_TARGET);
				A_SetSpeed(50.0,AAPTR_DEFAULT);
			}
			#### # 0 A_PlaySound("GoldenFlumptyAmbience",2,7.0,false, ATTN_NONE);
		LookAtLoop:
			CYBI A 1
			{
				A_GFlumptyThink();
				
				if (CheckInventory("Blackout", 1, AAPTR_TARGET))
				{
					SetStateLabel("Wander");
				}
				else if (CheckIfInTargetLOS(75.0, 0, 0, 0))
				{
					SetStateLabel("LookAtLoop");
				}
			}
			CYBI A 1 A_GFlumptyThink();
			CYBI A 0 A_LookEx(LOF_NOSOUNDCHECK,0,0,0,180,"LookAtLoop");
			Goto Spawn;
		LookAtWait:
			CYBI A 1 A_FaceTarget(360);
			goto LookAt;
		Wander:
			CYBI A 1 
			{
				My_ImprovedChase("Melee");
				A_FaceTarget();
			}
			CYBI A 1 
			{
				A_SetSpeed(0.01,AAPTR_TARGET);
				A_Stop();
			}
			Goto LookAt;
		Melee:
			#### # 2
			{
				A_QuakeEx( 3, 3, 3, 1, 0, 64, "", 0, 1, 1, 1, 0, 0, 3, 1);
				A_PlaySound("GoldenFlumptyScream", 0, 1.0);
				A_FaceTarget();
			}
			#### # 0 ACS_NamedExecuteAlways("EnemyAttack",0,0,0,0);
			CYBI UVWXYZ 1 A_FaceTarget();
			CYBA ABCDEFGHIJKLMNOPQRSTUVWXYZ 1 A_FaceTarget();
			CYBB ABCDEFGHIJKLMN 1 A_FaceTarget();
			Goto Chase;
		WanderLost:
			CYBI BCDEFGHIJKLMNOPQRSTUVWXYZ 2 A_Wander(CHF_NORANDOMTURN);
			Goto Wander;
			
	}
}

class BBB : Actor
{
	private int needstarget;
	private int playercount;
	private double angleLerpSpeed;
	override void PostBeginPlay()
	{
		Super.PostBeginPlay();
		angleLerpSpeed = 0.35;
		needstarget = 0;
		for (int i = 0; i < players.size(); i++)
			if (playeringame[i])
				playercount++;
	}
	Bool CheckFloorTexture(String texName)
    {
        String floorTex = TexMan.GetName(self.floorpic);
        return (floorTex == texName);
    }
	void FootStep()
	{
		If (CheckFloorTexture("FTILES1") || CheckFloorTexture("CONC5") || CheckFloorTexture("CONC4") || CheckFloorTexture("CONC2")) { A_PlaySound("MonsterTileStep",0,5.0); }
		Else If (CheckFloorTexture("CARPETS1") || CheckFloorTexture("CARPETS2") || CheckFloorTexture("CARPETS3") || CheckFloorTexture("CARPETS6")) { A_PlaySound("MonsterCarpetStep",0,5.0); }
		Else If (CheckFloorTexture("METL1") || CheckFloorTexture("METL2")) { A_PlaySound("MonsterVentStep",0,5.0); }
		Else If (CheckFloorTexture("GLAS1")) { A_PlaySound("MonsterGlassStep",0,5.0); }
		Else If (CheckFloorTexture("TDIRT")) { A_PlaySound("MonsterGrassStep",0,5.0); }
		Else If (CheckFloorTexture("CONC1")) { A_PlaySound("MonsterStoneStep",0,5.0); }
		Else If (CheckFloorTexture("OWOOD1")) { A_PlaySound("MonsterWoodStep",0,5.0); }
	}
	void My_ImprovedChase(statelabel MeleeState)
	{
		Actor target = self.target;
		if (!target)
			return;
		If (Target && Target.Health > 0)
		{
		double distanceToTarget = Distance3D(target);
			if (distanceToTarget < MeleeRange)
			{
				SetStateLabel(MeleeState);
				return;
			}
		}
		If (!CheckIfTargetInLOS(180.0,0,0))
		{ 
			A_Chase(MeleeState,null); 
			Return;
		}
		double dx = target.pos.x - self.pos.x;
		double dy = target.pos.y - self.pos.y;
		double distancia = sqrt(dx*dx + dy*dy);
		if (distancia > 0) { dx /= distancia; dy /= distancia; }
		double desiredAngle = VectorAngle(dx, dy);
		double currentAngle = self.angle;
		double angleDiff = DeltaAngle(currentAngle, desiredAngle);
		double newAngle = currentAngle + angleDiff * angleLerpSpeed;
		self.angle = newAngle;
		double moveSpeed = self.speed;
		self.vel.x = Cos(newAngle) * moveSpeed;
		self.vel.y = Sin(newAngle) * moveSpeed;
		A_SetSpeed(moveSpeed);
	}
	void A_BlamThink()
	{
		for (int x = 0; x < 8; x++)
		{
			if (!playeringame[x])
				continue;
			
			if (CheckSight(players[x].mo) && players[x].mo.health > 0)//There is a player in view.
			{
				needstarget = 0;
			
				if (random(0, 1024) > 1014-playercount)
				{
					switch (random(1, 4))
					{
						case 1:
							SetStateLabel("Wander");
							break;
						case 2:
							SetStateLabel("Wander");
							break;
						case 3:
							SetStateLabel("Wander");
							break;
						case 4:
							SetStateLabel("Chase");
							break;
					}
				}
			}
			else
			{
				needstarget++;
				if(needstarget > 4000)
				{
					needstarget = 0;
					SetStateLabel("Run");
				}
			
				if (random(0, 2048) > 2043-playercount)
				{
					SetStateLabel("Wander");
				}
			}
		}
	}

	void A_BlamWander()
	{
		A_Wander(CHF_NORANDOMTURN);
		A_LookEx(LOF_NOSOUNDCHECK, 0, 0, 0, 180, "Chase");
	}
	
	void A_BlamChase()
	{
		My_ImprovedChase("Melee");
	}
	
	Default
	{
		Health 2;
		Radius 18;
		Height 64;
		Mass 1000;
		Speed 3.6;
		Scale 2.2;
		PainChance 0;
		MeleeRange 46;
		CameraHeight 80;
		MaxStepHeight 64;
		MaxDropOffHeight 500;
		Species "Monster";
		RenderStyle "Normal";
		Alpha 1.0;
		Monster;
		+NOPAIN;
		+LOOKALLAROUND;
		+SLIDESONWALLS;
		+INVULNERABLE;
		+NODAMAGE;
		+DROPOFF;
		+INTERPOLATEANGLES;
		SeeSound "";
		PainSound "";
		DeathSound "";
		ActiveSound "";
		Obituary "%o met their fate to Birthday Boy Blam";
	}
	
	States
	{
		Spawn:
			CYBI A 1 A_BlamThink();
			CYBI A 1;
			CYBI A 0 A_Jump(ACS_NamedExecuteWithResult("BlamWanderDecide",0,0,0,0), "Wander"); //+14
			Loop;
		Stage:
			CYBI A 1;
			Loop;
		Wander:
			#### # 4
			{
				A_SetSpeed(6.4, AAPTR_DEFAULT);
			}
		WanderLoop:
			CYBI BCDEFGHIJKLM 2 A_BlamWander();
			CYBI N 2 
			{
				A_BlamWander();
				FootStep();
			}
			CYBI OPQRSTUVWXYZ 2 A_BlamWander();
			CYBA A 2 A_BlamWander();
			CYBA B 2 
			{
				A_BlamWander();
				FootStep();
			}
			Goto Chase;
		Chase:
			#### # 2
			{
				A_SetSpeed(3.9, AAPTR_DEFAULT);
			}
		ChaseLook:
			CYBI A 1 A_LookEx(0,0,0,0,360,"ChaseLoop");
			Loop;
		ChaseLoop:
			CYBI BCDEFGHIJKLM 1 A_BlamChase();
			CYBI N 1 
			{
				A_BlamChase();
				FootStep();
			}
			CYBI OPQRSTUVWXYZ 1 A_BlamChase();
			CYBA A 1 A_BlamChase();
			CYBA B 1 
			{
				A_BlamChase();
				FootStep();
			}
			CYBA B 0 A_Jump(ACS_NamedExecuteWithResult("BlamStopDecide",0,0,0,0), "LookAround"); //+32
			CYBA B 0
			{
				if (CheckProximity("ThePlayer", 500.0, 1, 0, AAPTR_DEFAULT))
				{
					if (random(0, 512) > ACS_NamedExecuteWithResult("BlamRunDecide",0,0,0,0)) //+500
					{
						SetStateLabel("Run");
					}
				}
			}
			Loop;
		Run:
			#### # 2
			{
				A_SetSpeed(7.0, AAPTR_DEFAULT);
			}
		RunLook:
			CYBA C 1 A_LookEx(0,0,0,0,360,"RunLoop");
			Loop;
		RunLoop:
			CYBA CDEFGHIJKL 1 A_BlamChase();
			CYBA M 1 
			{
				A_BlamChase();
				FootStep();
			}
			CYBA NOPQRSTUV 1 A_BlamChase();
			CYBA W 1 
			{
				A_BlamChase();
				FootStep();
			}
			#### # 0 A_Jump(ACS_NamedExecuteWithResult("BlamStopDecide",0,0,0,0), "LookAround"); //+31
			Loop;
		LookAround:
			#### # 6
			{
				A_Stop();
				A_ClearTarget();
				A_BlamThink();
			}
			CYBA XYZ 2 A_BlamThink();
			CYBB ABCDEFGHIJKLMNOPQRSTUVWXYZ 2 A_BlamThink();
			CYBC ABCDEFGHIJKLMNOPQRST 2 A_BlamThink();
			#### # 0 A_Jump(20,"Chase","Wander","Run");
			Loop;
		Melee:
			#### # 4
			{
				A_QuakeEx( 3, 3, 3, 1, 0, 64, "", 0, 1, 1, 1, 0, 0, 3, 1);
				A_PlaySound("BirthdayBoyBlamScream", 0, 1.0);
				A_FaceTarget();
			}
			#### # 0 ACS_NamedExecuteAlways("EnemyAttack",0,0,0,0);
			CYBC UVWXYZ 1 A_FaceTarget();
			CYBD ABCDEFGHIJKLMNOPQRSTUVWXYZ 1 A_FaceTarget();
			CYBE ABCDEFGH 1 A_FaceTarget();
			Goto Spawn;
	}
}

class Beaver : Actor
{
	Private int Delay;
	Private Int InDuct;
	private bool IsCrouch;
	private bool Returning;
	private int counter;
	private int playercount;
	private double angleLerpSpeed;
	Bool CheckFloorTexture(String texName)
    {
        String floorTex = TexMan.GetName(self.floorpic);
        return (floorTex == texName);
    }
	override void PostBeginPlay()
	{
		angleLerpSpeed = 0.35;
		playercount = 1;
		Returning = FALSE;
		IsCrouch = FALSE;
		Delay = 30;
		InDuct = 2;
		angleLerpSpeed = 0.35;
		for (int i = 0; i < players.size(); i++)
			if (playeringame[i])
				playercount++;
		Super.PostBeginPlay();
	}
	void FootStep()
	{
		A_PlaySound("BeaverStep",0,3.5);
		If (CheckFloorTexture("FTILES1") || CheckFloorTexture("CONC5") || CheckFloorTexture("CONC4") || CheckFloorTexture("CONC2")) { A_PlaySound("MonsterTileStep",0,5.0); }
		Else If (CheckFloorTexture("CARPETS1") || CheckFloorTexture("CARPETS2") || CheckFloorTexture("CARPETS3") || CheckFloorTexture("CARPETS6")) { A_PlaySound("MonsterCarpetStep",0,5.0); }
		Else If (CheckFloorTexture("METL1") || CheckFloorTexture("METL2")) { A_PlaySound("MonsterVentStep",0,5.0); }
		Else If (CheckFloorTexture("GLAS1")) { A_PlaySound("MonsterGlassStep",0,5.0); }
		Else If (CheckFloorTexture("TDIRT")) { A_PlaySound("MonsterGrassStep",0,5.0); }
		Else If (CheckFloorTexture("CONC1")) { A_PlaySound("MonsterStoneStep",0,5.0); }
		Else If (CheckFloorTexture("OWOOD1")) { A_PlaySound("MonsterWoodStep",0,5.0); }
	}
	void My_ImprovedChase(statelabel MeleeState)
	{
		If (CheckFloorTexture("OWOOD1"))
		{
			A_Wander(CHF_NORANDOMTURN);
			If (CheckIfTargetInLOS(360.0,0,46)) { SetStateLabel("Jumpscare"); }
			Return;
		}
		Actor target = self.target;
		if (!target)
			return;
		If (Target && Target.Health > 0)
		{
		double distanceToTarget = Distance3D(target);
			if (distanceToTarget < MeleeRange)
			{
				SetStateLabel(MeleeState);
				return;
			}
		}
		If (!CheckIfTargetInLOS(180.0,0,0))
		{ 
			A_Chase(MeleeState,null); 
			Return;
		}
		double dx = target.pos.x - self.pos.x;
		double dy = target.pos.y - self.pos.y;
		double distancia = sqrt(dx*dx + dy*dy);
		if (distancia > 0) { dx /= distancia; dy /= distancia; }
		double desiredAngle = VectorAngle(dx, dy);
		double currentAngle = self.angle;
		double angleDiff = DeltaAngle(currentAngle, desiredAngle);
		double newAngle = currentAngle + angleDiff * angleLerpSpeed;
		self.angle = newAngle;
		double moveSpeed = self.speed;
		self.vel.x = Cos(newAngle) * moveSpeed;
		self.vel.y = Sin(newAngle) * moveSpeed;
		A_SetSpeed(moveSpeed);
	}
	void BeaverIdle()
	{
		If (IsCrouch == FALSE)
		{
			if (random(0, 571) > 500) { SetStateLabel("Wander"); }
			If (Target) { If (CheckIfTargetInLOS(75.0,100,968)) { SetStateLabel("RunChase"); } }
			Else If (!Target) { If (CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING)) { SetStateLabel("Idle"); } }
		}
		Else If (IsCrouch == TRUE)
		{
			If (CheckInventory("IsChasingFast",1,AAPTR_DEFAULT) || random(0, 571) > 500) { SetStateLabel("CrouchWalk"); }
			If (Target) { If (CheckIfTargetInLOS(75.0,100,968)) { SetStateLabel("CrouchWalk"); } }
			Else If (!Target) { If (CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING)) { SetStateLabel("CrouchIdle"); } }
		}
	}
	void BeaverWander()
	{
		Speed = 2.8;
		A_GiveInventory("IsChasingSlow2",999);
		if (target)
		{
			If (!CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING)) { My_ImprovedChase(null); }
			Else If (CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING)) { A_Wander(CHF_NORANDOMTURN); }
		}
		If (CheckIfTargetInLOS(75.0,0,1024,0)) { SetStateLabel("RunChase"); }
		if (random(0, 1025) > 1024) { SetStateLabel("Wander"); }
		If (CheckProximity("VentNear",24.0,1,AAPTR_DEFAULT)) { SetStateLabel("ToCrouch"); }
	}
	void BeaverRun()
	{
		A_TakeInventory("IsChasingSlow2",999);
		If (Target)
		{
			If (CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING)) { Speed = 11.7; }
			Else { Speed = 15.10; }
		}
		If (Returning == FALSE) 
		{ 
			A_GiveInventory("IsChasingFast",999);
			My_ImprovedChase("Jumpscare"); 
			If (CheckProximity("CheckDoorProxHit", 52.4, 1, 0, AAPTR_DEFAULT)) { SetStateLabel("DoorPound"); }
			If (CheckProximity("VentNear",24.0,1,AAPTR_DEFAULT)) { SetStateLabel("ToCrouch"); }
		}
		If (Returning == TRUE) 
		{ 
			If (CheckProximity("Toilet",176.0,1,0, AAPTR_DEFAULT)) { SetStateLabel("ToRun"); }
			A_Chase(null,null); 
		}
	}
	void BeaverCrouchWalk()
	{
		Speed = 2.6;
		My_ImprovedChase("Jumpscare"); 
	}
	override void Tick()
    {
        Super.Tick();
	//If no Duct
		if (!CheckFloorTexture("METL2") && IsCrouch == TRUE)
		{
			//Console.printf("%s == InDuct %d", self.GetClassName(), InDuct);
			if (Delay-- <= 0)
			{
				Delay = 30;
				InDuct -= 1;
				if (InDuct <= 0) 
				{ 
					InDuct = 2;
					SetStateLabel("ToStand");
					A_Stop();
					A_SetSize(-1,57);
					IsCrouch = FALSE;
				}
			}
		}
    }
	Default
	{
		Radius 18;
		Height 57;
		Scale 17.5;
		MeleeRange 46;
		MaxStepHeight 500;
		MaxDropOffHeight 500;
		Monster;
		+DECOUPLEDANIMATIONS
		+NOPAIN
		+LOOKALLAROUND
		+SLIDESONWALLS
		+INVULNERABLE
		+NODAMAGE
		+DROPOFF
		+INTERPOLATEANGLES
	}
	States
	{
	Spawn:
		M000 A 1;
		M000 A 1 A_LookEx(0,0,0,0,360,"Idle");
		Loop;
	Reading:
		M000 A 1 SetAnimation('Reading', framerate:17.5, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 A 1;
		Wait;
	DropingNewspaper:
		M000 A 1 SetAnimation('DropingNewspaper', framerate:35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
	WaitingFor:
		M000 A 1 SetAnimation('Waiting', framerate:0, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1;
		Wait;
	Lifting:
		M000 A 1 SetAnimation('Lifting', framerate:35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 AAAAAAAAAAAAAAAAAAAAAAAA 1;
		M000 A 1;
		Goto Idle;
	ToRun:
		M000 A 1 SetAnimation('ToRun', framerate:0, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1;
		Wait;
	Idle:
		M000 A 1 SetAnimation('Idle', framerate:25, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 A 1 BeaverIdle();
		Wait;
	Wander:
		M000 A 1 SetAnimation('Wander', framerate:35, interpolatetics: 4, flags:SAF_LOOP|SAF_NOOVERRIDE);
	WanderLoop:
		M000 A 1
		{
			FootStep();
			BeaverWander();
		}
		M000 AAAAAAAAAAAAAAAAAAAAA 1 BeaverWander();
		M000 A 1
		{
			FootStep();
			BeaverWander();
		}
		M000 AAAAAAAAAAAAAAAAAAA 1 BeaverWander();
		Loop;
	RunChase:
		M000 A 1 SetAnimation('Run', framerate:35, interpolatetics: 2, flags:SAF_LOOP|SAF_NOOVERRIDE);
	RunChaseLoop:
		M000 AAA 1 BeaverRun();
		M000 A 1
		{
			FootStep();
			BeaverRun();
		}
		M000 AAAAAAAAAA 1 BeaverRun();
		M000 A 1
		{
			FootStep();
			BeaverRun();
		}
		M000 AAAAAAAA 1 BeaverRun();
		Loop;
	DoorPound:
		M000 A 1 SetAnimation('Knock', framerate:35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1
		{
			A_TakeInventory("IsChasingFast",999);
			A_GiveInventory("BeaverHasHitDoor",999);
		}
		M000 AAAAA 1;
		M000 A 1 A_PlaySound("Knock",0,1.0);
		M000 AAAAAAAAAAAAAA 1;
		M000 A 1 
		{
			Returning = TRUE;
			A_TakeInventory("BeaverHasHitDoor",999);
			ACS_NamedExecuteAlways("ReturnToToilet",0,0,0,0);
		}
		Goto RunChase;
	Jumpscare:
		M000 A 1 
		{
			If (IsCrouch == TRUE) { SetAnimation('CrouchJumpscare', framerate:35, interpolatetics: 5, flags:SAF_NOOVERRIDE); }
			Else If (IsCrouch == FALSE) { SetAnimation('Jumpscare', framerate:35, interpolatetics: 5, flags:SAF_NOOVERRIDE); }
		}
		M000 A 1
		{
			A_TakeInventory("IsChasingFast",999);
			A_GiveInventory("BeaverHasHitDoor",999);
			A_FaceTarget();
			A_SetAngle(Angle + 180,SPF_INTERPOLATE,AAPTR_TARGET);
			A_QuakeEx( 1, 1, 1, 15, 0, 64, "", 0, 1, 1, 1, 0, 0, 3, 1);
			A_PlaySound("BeaverScream",0,1.0);
			ACS_NamedExecuteAlways("EnemyAttack",0,0,0,0);
		}
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
		M000 A 1 
		{
			Returning = TRUE;
			A_TakeInventory("BeaverHasHitDoor",999);
			ACS_NamedExecuteAlways("ReturnToToilet",0,0,0,0);
		}
		Goto RunChase;
	ToStand:
		M000 A 1 SetAnimation('ToStand', framerate:35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1
		{
			IsCrouch = FALSE;
			A_SetSize(-1,57);
		}
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
		M000 A 1
		{
			If (!CheckInventory("IsChasingFast",1,AAPTR_DEFAULT))
			{
				int RandomDecide = random(1,2);
				switch (RandomDecide)
				{
					Case 1:
					SetStateLabel("Idle");
					Break;
					Case 2:
					SetStateLabel("Wander");
					Break;
				}
			}
		}
		Goto RunChase;
	ToCrouch:
		M000 A 1 SetAnimation('ToCrouch', framerate:35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1
		{
			IsCrouch = TRUE;
			A_SetSize(-1,16);
		}
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
	CrouchIdle:
		M000 A 1 SetAnimation('CrouchIdle', framerate:35, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 A 1 BeaverIdle();
		Wait;
	CrouchWalk:
		M000 A 1 SetAnimation('CrouchWalk', framerate:35, interpolatetics: 5, flags:SAF_LOOP|SAF_NOOVERRIDE);
	CrouchWalkLoop:
		M000 A 1
		{
			FootStep();
			BeaverCrouchWalk();
		}
		M000 AAAAAAAAAAAAAAAA 1 BeaverCrouchWalk();
		M000 A 1
		{
			FootStep();
			BeaverCrouchWalk();
		}
		M000 AAAAAAAAAA 1 BeaverCrouchWalk();
		Loop;
	}
}

class BeaverNewspaper : Actor
{
	Private Bool OnFloor;
	override void Activate(Actor activator) 
	{ 
		If (OnFloor == FALSE)
		{
			A_PlaySound("NewspaperCrack",0,1.0);
			ACS_NamedExecuteAlways("ForceBeaver",0,0,0,0);
			Self.Destroy();
		}
	}
	Default
	{
		Radius 15;
		Height 5;
		Scale 17.5;
		Activation THINGSPEC_Switch;
		-SOLID
		+NOGRAVITY
		+USESPECIAL
		+DECOUPLEDANIMATIONS
	}
	States
	{
	Spawn:
		M000 A 1;
		M000 A 1 SetAnimation('Reading', framerate:17.5, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 A 1;
		Wait;
	DropingNewspaper:
		M000 A 1 SetAnimation('DropingNewspaper', framerate:35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1 { OnFloor = TRUE; }
		M000 A 1;
		Wait;
	}
}

class Grunkfuss : Actor
{
	private int playercount;
	private double angleLerpSpeed;
	Bool CheckFloorTexture(String texName)
    {
        String floorTex = TexMan.GetName(self.floorpic);
        return (floorTex == texName);
    }
	void FootStep()
	{
		A_PlaySound("ClownStep",0,1.5);
		If (CheckFloorTexture("FTILES1") || CheckFloorTexture("CONC5") || CheckFloorTexture("CONC4") || CheckFloorTexture("CONC2")) { A_PlaySound("MonsterTileStep",0,5.0); }
		Else If (CheckFloorTexture("CARPETS1") || CheckFloorTexture("CARPETS2") || CheckFloorTexture("CARPETS3") || CheckFloorTexture("CARPETS6")) { A_PlaySound("MonsterCarpetStep",0,5.0); }
		Else If (CheckFloorTexture("METL1") || CheckFloorTexture("METL2")) { A_PlaySound("MonsterVentStep",0,5.0); }
		Else If (CheckFloorTexture("GLAS1")) { A_PlaySound("MonsterGlassStep",0,5.0); }
		Else If (CheckFloorTexture("TDIRT")) { A_PlaySound("MonsterGrassStep",0,5.0); }
		Else If (CheckFloorTexture("CONC1")) { A_PlaySound("MonsterStoneStep",0,5.0); }
		Else If (CheckFloorTexture("OWOOD1")) { A_PlaySound("MonsterWoodStep",0,5.0); }
	}
	void My_ImprovedChase(statelabel MeleeState)
	{
		Actor target = self.target;
		if (!target)
			return;
		If (Target && Target.Health > 0)
		{
		double distanceToTarget = Distance3D(target);
			if (distanceToTarget < MeleeRange)
			{
				SetStateLabel(MeleeState);
				return;
			}
		}
		If (!CheckIfTargetInLOS(180.0,0,0))
		{ 
			A_Chase(MeleeState,null); 
			Return;
		}
		double dx = target.pos.x - self.pos.x;
		double dy = target.pos.y - self.pos.y;
		double distancia = sqrt(dx*dx + dy*dy);
		if (distancia > 0) { dx /= distancia; dy /= distancia; }
		double desiredAngle = VectorAngle(dx, dy);
		double currentAngle = self.angle;
		double angleDiff = DeltaAngle(currentAngle, desiredAngle);
		double newAngle = currentAngle + angleDiff * angleLerpSpeed;
		self.angle = newAngle;
		double moveSpeed = self.speed;
		self.vel.x = Cos(newAngle) * moveSpeed;
		self.vel.y = Sin(newAngle) * moveSpeed;
		A_SetSpeed(moveSpeed);
	}
	override void PostBeginPlay()
	{
		angleLerpSpeed = 0.35;
		playercount = 1;
	
		for (int i = 0; i < players.size(); i++)
			if (playeringame[i])
				playercount++;
		Super.PostBeginPlay();
	}

	void A_ClownWander()
	{
		A_Wander(CHF_NORANDOMTURN);
		A_LookEx(0, 0, 0, 650, 180, "Chase");
		
		if (random(0, 512) > 509-(playercount*3))
		{
			SetStateLabel("Chase");
		}
	}
	
	void A_ClownChase()
	{
		My_ImprovedChase("Melee");
		
		if (random(0, 1024) > 1022)
		{
			SetStateLabel("Run");
		}
		
		if (CheckProximity("ClownProxIn", 24.0, 1, 0, AAPTR_DEFAULT))
		{
			SetStateLabel("Crouch");
		}
	}
	
	void A_CrouchSee()
	{
		My_ImprovedChase("Melee");
		
		if (CheckProximity("ClownProxOut", 22.0, 1, 0, AAPTR_DEFAULT))
		{
			SetStateLabel("Uncrouch");
		}
	}
	
	Default
	{
		Health 2;
		Radius 18;
		Height 64;
		Mass 1000;
		Speed 1.0;
		Scale 1.6;
		PainChance 0;
		MeleeRange 51;
		CameraHeight 80;
		MaxStepHeight 500;
		MaxDropOffHeight 500;
		Species "Clown";
		RenderStyle "Normal";
		Alpha 1.0;
		Monster;
		+NOPAIN;
		+LOOKALLAROUND;
		+SLIDESONWALLS;
		+INVULNERABLE;
		+NODAMAGE;
		+DROPOFF;
		+INTERPOLATEANGLES;
		SeeSound "";
		PainSound "";
		DeathSound "";
		ActiveSound "";
		Obituary "%o met their fate to Grunkfuss";
	}
	
	States
	{
		Spawn:
			CYBA Q 1 A_LookEx(0, 0, 0, 650, 180, "Chase");
			CYBA Q 1;
			CYBA Q 0 A_Jump(14, "Wander");
			Loop;
		Stage:
			CYBA Q 1;
			Loop;
		WanderLost:
			#### # 0 A_SetSpeed(3.7, AAPTR_DEFAULT);
			CYBA RSTUVWX 1 A_Wander(CHF_NORANDOMTURN);
			CYBA Y 1
			{
				A_Wander(CHF_NORANDOMTURN);
				FootStep();
			}
			CYBA Z 1 A_Wander(CHF_NORANDOMTURN);
			CYBB ABCDEFGHIJKLMNO 1 A_Wander(CHF_NORANDOMTURN);
			CYBB P 1
			{
				A_Wander(CHF_NORANDOMTURN);
				FootStep();
			}
			CYBB QRSTUVWX 1 A_Wander(CHF_NORANDOMTURN);
		Wander:
			#### # 0 A_SetSpeed(3.7, AAPTR_DEFAULT);
			CYBA RSTUVWX 1 A_ClownWander();
			CYBA Y 1
			{
				A_ClownWander();
				FootStep();
			}
			CYBA Z 1 A_ClownWander();
			CYBB ABCDEFGHIJKLMNO 1 A_ClownWander();
			CYBB P 1
			{
				A_ClownWander();
				FootStep();
			}
			CYBB QRSTUVWX 1 A_ClownWander();
			CYBB X 0 A_Jump(12, "LoseTarget");
		Chase:
			CYBA Q 1 A_LookEx(0,0,0,0,360,"ChaseLoop");
			Loop;
		ChaseLoop:
			#### # 0 A_SetSpeed(4.2, AAPTR_DEFAULT);
			CYBA RSTUVWX 1 A_ClownChase();
			CYBA Y 1
			{
				A_ClownChase();
				FootStep();
			}
			CYBA Z 1 A_ClownChase();
			CYBB ABCDEFGHIJKLMNO 1 A_ClownChase();
			CYBB P 1
			{
				A_ClownChase();
				FootStep();
			}
			CYBB QRSTUVWX 1 A_ClownChase();
			CYBB X 0 A_Jump(16, "LoseTarget", "Run");
			Loop;
		Run:
			#### # 0 A_SetSpeed(9.3, AAPTR_DEFAULT);
			CYBB YZ 1 A_ClownChase();
			CYBC AB 1 A_ClownChase();
			CYBC C 1
			{
				A_ClownChase();
				FootStep();
			}
			CYBC DEFGHI 1 A_ClownChase();
			CYBC J 1
			{
				A_ClownChase();
				FootStep();
			}
			CYBC KLMNO 1 A_ClownChase();
			#### # 0 A_Jump(31, "LoseTarget");
			Loop;
		Crouch:
			CYBA PONMLK 1;
			#### # 0 A_SetSize(-1, 21);
			Goto CrouchMove;
		CrouchMove:
			#### # 0 A_SetSpeed(8.7, AAPTR_DEFAULT);
			CYBI ABCDEFGHIJKLMNOPQRSTUVWXYZ 1 A_CrouchSee();
			CYBA ABCDEFGHIJ 1 A_CrouchSee();
			Loop;
		Uncrouch:
			#### # 0 A_SetSize(-1, 64);
			CYBA KLMNOP 1;
			CYBA P 0 A_Jump(55, "Run");
			Goto Chase;
		LoseTarget:
			#### # 0 A_Stop();
			#### # 0 A_ClearTarget();
			Goto Spawn;
		Melee:
			#### # 6
			{
				A_QuakeEx( 3, 3, 3, 1, 0, 64, "", 0, 1, 1, 1, 0, 0, 3, 1);
				A_PlaySound("GrunkfussTheClownScream", 0, 1.0);
				A_FaceTarget(360);
			}
			#### # 0 ACS_NamedExecuteAlways("EnemyAttack",0,0,0,0);
			CYBC PQRSTUVWXYZ 1 A_FaceTarget(360);
			CYBD ABCDEFGHIJKLMNOPQRSTUVWXYZ 1 A_FaceTarget(360);
			CYBE ABCD 1 A_FaceTarget(360);
			Goto Spawn;
		Pain:
			CYBA Q 15;
			Goto Spawn;
	}
}

class Flumpty : Actor
{
	Private Bool HaveATarget;
	Private Bool MonsterCrouching;
	Private Int TargetDelay;
	Private Int SearchTarget;
	Private Int Aggro;
	private double angleLerpSpeed;
	override void PostBeginPlay()
	{
		Super.PostBeginPlay();
		Aggro = 0;
		SearchTarget = 23;
		TargetDelay = 30;
		HaveATarget = FALSE;
		angleLerpSpeed = 0.05;
	}
	Bool CheckFloorTexture(String texName)
    {
        String floorTex = TexMan.GetName(self.floorpic);
        return (floorTex == texName);
    }
	void FootStep()
	{
		If (CheckFloorTexture("FTILES1") || CheckFloorTexture("CONC5") || CheckFloorTexture("CONC4") || CheckFloorTexture("CONC2")) { A_PlaySound("MonsterTileStep",0,5.0); }
		Else If (CheckFloorTexture("CARPETS1") || CheckFloorTexture("CARPETS2") || CheckFloorTexture("CARPETS3") || CheckFloorTexture("CARPETS6")) { A_PlaySound("MonsterCarpetStep",0,5.0); }
		Else If (CheckFloorTexture("METL1") || CheckFloorTexture("METL2")) { A_PlaySound("MonsterVentStep",0,5.0); }
		Else If (CheckFloorTexture("GLAS1")) { A_PlaySound("MonsterGlassStep",0,5.0); }
		Else If (CheckFloorTexture("TDIRT")) { A_PlaySound("MonsterGrassStep",0,5.0); }
		Else If (CheckFloorTexture("CONC1")) { A_PlaySound("MonsterStoneStep",0,5.0); }
		Else If (CheckFloorTexture("OWOOD1")) { A_PlaySound("MonsterWoodStep",0,5.0); }
	}
	override void Tick()
    {
        Super.Tick();
		A_RadiusThrust(100,64,RTF_NOTMISSILE|RTF_NOIMPACTDAMAGE,64);
	//New target
		if (target)
		{
			If (CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING)) { HaveATarget = TRUE; }
		}			
	//Lose Target
		if (target)
		{
			if (!CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING) && HaveATarget == TRUE)
			{
				if (TargetDelay-- <= 0)
				{
					TargetDelay = 30;
					SearchTarget -= 1;
					if (SearchTarget <= 0) 
					{ 
						SearchTarget = 23;
						HaveATarget = FALSE;
					}
				}
			}
		}
	//Flumpty's Voice
		If (Random(0,7592) > 7591) { A_StartSound("CHUCKLED"); }
    }
	void My_ImprovedChase(statelabel MeleeState)
	{
		If (HaveATarget == FALSE || CheckFloorTexture("OWOOD1"))
		{
			A_Wander(CHF_NORANDOMTURN);
			If (CheckIfTargetInLOS(360.0,0,46)) { SetStateLabel("Jumpscare"); }
			Return;
		}
		Else If (HaveATarget == TRUE)
		{
			Actor target = self.target;
			if (!target)
				return;
			If (Target && Target.Health > 0)
			{
			double distanceToTarget = Distance3D(target);
				if (distanceToTarget < MeleeRange)
				{
					SetStateLabel(MeleeState);
					return;
				}
			}
			If (!CheckIfTargetInLOS(180.0,0,0))
			{ 
				A_Chase(MeleeState,null); 
				Return;
			}
			
			double dx = target.pos.x - self.pos.x;
			double dy = target.pos.y - self.pos.y;
			double distancia = sqrt(dx*dx + dy*dy);
			if (distancia > 0) { dx /= distancia; dy /= distancia; }
			double desiredAngle = VectorAngle(dx, dy);
			double currentAngle = self.angle;
			double angleDiff = DeltaAngle(currentAngle, desiredAngle);
			double newAngle = currentAngle + angleDiff * angleLerpSpeed;
			self.angle = newAngle;
			double moveSpeed = self.speed;
			self.vel.x = Cos(newAngle) * moveSpeed;
			self.vel.y = Sin(newAngle) * moveSpeed;
			A_SetSpeed(moveSpeed);
		}
	}
	void A_FlumptyIdle()
	{
		If (CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING))
		{
			int RandomDecide = random(1,2);
			switch (RandomDecide)
			{
				Case 1:
				SetStateLabel("WalkChase");
				Break;
				Case 2:
				SetStateLabel("RunChase");
				Break;
			}
		}
		If (Random(0,900) < 899) { SetStateLabel("WalkChase"); } //Wander
	}
	void A_FlumptyWalkChase()
	{
		Speed = 3.2;
		My_ImprovedChase("Jumpscare");
		If (CheckSight(Target,SF_SEEPASTBLOCKEVERYTHING))
		{
			If (CountInv('HourPlusOne') == 1) { Aggro += 1; }
			Else If (CountInv('HourPlusOne') == 2) { Aggro += 5; }
			Else If (CountInv('HourPlusOne') == 3) { Aggro += 10; }
			Else If (CountInv('HourPlusOne') == 4) { Aggro += 15; }
			Else If (CountInv('HourPlusOne') == 5) { Aggro += 20; }
			Else If (Aggro >= 125) { SetStateLabel("RunChase"); }
		}
	}
	Void A_FlumptyRunChase()
	{
		Speed = 8.7;
		My_ImprovedChase("Jumpscare");
		//If (CheckIfTargetInLOS(360.0,1536.0,0)) { SetStateLabel("SpinJump"); }
		If (HaveATarget == FALSE) { SetStateLabel("Idle"); }
	}
	Default
	{
		Height 64;
		Radius 13;
		SCALE 1.47;
		PainChance 0;
		MeleeRange 46;
		MaxStepHeight 500;
		MaxDropOffHeight 500;
		Monster;
		+NOPAIN
		+NOBLOOD
		+NOBLOODDECALS
		+SLIDESONWALLS
		+INVULNERABLE
		+NODAMAGE
		+DECOUPLEDANIMATIONS
	}
	States
	{
	Spawn:
		M000 A 1 SetAnimation('TPose', FrameRate: 35, flags:SAF_NOOVERRIDE);
		M000 A 1 A_LookEx(0,0,0,0,360,"Idle");
		Loop;
	PhoneCall:
		M000 A 1 SetAnimation('PhoneCall', FrameRate: 17.5, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
		Loop;
	PhoneCallEnd:
		M000 A 1 SetAnimation('Run', FrameRate: 35, interpolatetics: 2, flags:SAF_LOOP|SAF_NOOVERRIDE);
	PhoneCallEndLoop:
		M000 AAAA 1 A_Chase(null,null);
		M000 A 1
		{
			FootStep();
			A_Chase(null,null);
		}
		M000 AAAAAAAAA 1 A_Chase(null,null);
		M000 A 1
		{
			FootStep();
			A_Chase(null,null);
		}
		M000 AAAAAA 1 A_Chase(null,null);
		Loop;
	Deactive:
		M000 A 1 SetAnimation('Inactive', FrameRate: 35, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 A 1;
		Wait;
	Active:
		M000 A 1 SetAnimation('Active', FrameRate: 35, flags:SAF_NOOVERRIDE);
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
		M000 A 1 A_PlaySound("FlumptyMyTurn",0,1.0);
		Goto WalkChase;
	Idle:
		M000 A 1 SetAnimation('Idle', FrameRate: 6, interpolatetics: 6, flags:SAF_LOOP|SAF_NOOVERRIDE);
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1 A_FlumptyIdle();
		Loop;
	WalkChase:
		Goto RunChase;
		M000 A 1 SetAnimation('Walk', FrameRate: 35, interpolatetics: 4, flags:SAF_LOOP|SAF_NOOVERRIDE);
	WalkChaseLoop:
		M000 A 1
		{
			FootStep();
			A_FlumptyWalkChase();
		}
		M000 AAAAAAAAAAAAAA 1 A_FlumptyWalkChase();
		M000 A 1
		{
			FootStep();
			A_FlumptyWalkChase();
		}
		M000 AAAAAAAAAAAAAAA 1 A_FlumptyWalkChase();
		Loop;
	SpinJump:
		M000 A 1 SetAnimation('SpinJump', FrameRate: 17.5, interpolatetics: 6, flags:SAF_NOOVERRIDE);
		M000 AAAAAAAA 1 A_FaceTarget();
		M000 A 1 A_ChangeVelocity(2.5,0,0,1);
		M000 AAAAAAAAA 1;
		M000 A 1
		{
			A_Stop();
			A_PlaySound("FlumptyHitWall",0,1.0);
		}
		M000 AAA 1;
	RunChase:
		M000 A 1 SetAnimation('Run', FrameRate: 35, interpolatetics: 2, flags:SAF_LOOP|SAF_NOOVERRIDE);
	RunChaseLoop:
		M000 AAAA 1 A_FlumptyRunChase();
		M000 A 1
		{
			FootStep();
			A_FlumptyRunChase();
		}
		M000 AAAAAAAAA 1 A_FlumptyRunChase();
		M000 A 1
		{
			FootStep();
			A_FlumptyRunChase();
		}
		M000 AAAAAA 1 A_FlumptyRunChase();
		Loop;
	Jumpscare:
		M000 A 1 SetAnimation('Jumpscare', framerate:35, interpolatetics: 5, flags:SAF_NOOVERRIDE);
		M000 A 1
		{
			A_FaceTarget();
			A_SetAngle(Angle + 180,SPF_INTERPOLATE,AAPTR_TARGET);
			A_QuakeEx( 1, 1, 1, 15, 0, 64, "", 0, 1, 1, 1, 0, 0, 3, 1);
			A_PlaySound("FlumptyScream",0,1.0);
			ACS_NamedExecuteAlways("EnemyAttack",0,0,0,0);
		}
		M000 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 1;
		Goto WalkChase;
	}
}